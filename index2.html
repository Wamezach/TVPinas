<?php
?><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVPinas (Shaka+Firebase+Search)</title>
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/9/99/Flag_of_the_Philippines.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Shaka Player -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/shaka-player.compiled.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- FontAwesome and Icons8 for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg,#0c0c0c 60%,#18181b 100%); color: #fff; }
        .hero-gradient { background-image: linear-gradient(to right, rgba(0,0,0,0.9) 20%, rgba(0,0,0,0.2) 60%, transparent 100%);}
        .row-container::-webkit-scrollbar {display: none;}
        .row-container { -ms-overflow-style: none; scrollbar-width: none;}
        .channel-tile {
            transition: transform 0.23s cubic-bezier(0.4,0,0.2,1), box-shadow 0.23s cubic-bezier(0.4,0,0.2,1);
            flex-shrink: 0;
            position:relative;
            z-index:1;
            animation: popIn 0.7s cubic-bezier(0.2,0.7,0.4,1.2) both;
            border: 2px solid transparent;
        }
        @keyframes popIn {
            0% {transform: scale(0.95) translateY(10px); opacity:0;}
            60% {transform: scale(1.05) translateY(-8px);}
            100% {transform: scale(1) translateY(0); opacity:1;}
        }
        .channel-tile:hover, .channel-tile:focus { 
            transform: scale(1.09) translateY(-4px); 
            z-index: 20; 
            box-shadow: 0 10px 32px 0 rgba(0,0,0,0.7), 0 1.5px 0 #007bff;
            border:2.5px solid #007bff;
        }
        .channel-tile:focus { outline: 2.5px solid #fff;}
        .row-arrow { 
            opacity: 0; transition: opacity 0.2s; 
            background-color: rgba(0,0,0,0.55);
            backdrop-filter: blur(2px);
        }
        .row:hover .row-arrow { opacity: 1;}
        .loader { border: 7px solid #4b5563; border-top: 7px solid #007bff; border-radius: 50%; width: 64px; height: 64px; animation: spin 1.2s linear infinite;}
        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
        .view { transition: opacity 0.3s; }
        .view.hidden { opacity: 0; pointer-events: none; }
        .search-bar { background: #18181b; color: #fff; border: none; padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-size: 1.125rem; width: 100%; margin-bottom: 2rem; }
        .search-bar:focus { outline: 2.5px solid #007bff; }
        .channel-logo { max-height: 68px; object-fit: contain; margin-bottom: 0.5rem; filter: drop-shadow(0 2px 6px #0007);}
        footer { background: #18181b; color: #b3b3b3; padding: 2.5rem 0 1.2rem 0; box-shadow: 0 0px 8px #000c;}
        .footer-link { color: #007bff; text-decoration: underline; }
        .footer-link:hover { color: #fff; }
        .footer-icons a { margin-right: 1rem; color: #007bff; font-size: 2.1rem; transition: color 0.2s, transform 0.2s;}
        .footer-icons a:hover { color: #fff; transform: scale(1.18);}
        .category-icon { font-size: 1.3em; margin-right: 0.45em; vertical-align: middle; }
        .about-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.78);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .about-overlay.active {
            opacity: 1;
            pointer-events: auto;
            animation: fadeInBg 0.4s;
        }
        @keyframes fadeInBg {
            from {opacity:0;}
            to {opacity:1;}
        }
        .about-modal {
            background: linear-gradient(120deg,#18181b 85%,#007bff 100%);
            color: #fff;
            border-radius: 1.2rem;
            padding: 2.2rem 2.7rem;
            max-width: 95vw;
            width: 410px;
            box-shadow: 0 12px 50px 0 #000a, 0 1.5px 0 #007bff;
            position: relative;
            text-align: center;
            border:2.5px solid #007bff;
            animation: popIn .7s;
        }
        .about-close {
            position: absolute;
            right: 1.2rem;
            top: 1.2rem;
            background: none;
            border: none;
            font-size: 2.1rem;
            color: #007bff;
            cursor: pointer;
            transition: color 0.18s;
        }
        .about-close:hover { color: #fff; }
        .about-logo {
            width: 68px;
            height: 68px;
            margin-bottom: 1rem;
            border-radius: 14px;
            background: #18181b;
            box-shadow: 0 2px 18px #007bffa0;
            display: inline-block;
            animation: popIn .6s;
        }
        .visit-count {
            font-weight: 700;
            color: #007bff;
            font-size: 1.4em;
            display:inline-flex;
            align-items:center;
            gap:0.45em;
            animation: fadeInBg 1.1s 0.1s both;
        }
        .visit-count i { color: #007bff; font-size:1.3em;}
        .footer-visit { margin-top:0.8em; font-size:1.1em; }
        .channel-tile .fa-tv { color:#007bff; margin-bottom:0.25em;}
        .hero-featured {animation: pulseGlow 2.4s infinite alternate cubic-bezier(.6,0,.4,1);}
        @keyframes pulseGlow {
            0% {box-shadow:0 0 0 0 #007bff44;}
            100% {box-shadow:0 0 30px 8px #007bff66;}
        }
    </style>
    <script>
    // ---- PREVENT INDEX2 LOAD WITHOUT LOGIN ----
    (function() {
        // Only allow navigation if a special flag is set in sessionStorage (set after successful login)
        if (!sessionStorage.getItem('tvpinas_loggedin')) {
            // Not coming from login, redirect to login page (index.html)
            window.location.replace('index.html');
        }
    })();
    </script>
</head>
<body class="overflow-x-hidden">

    <!-- Main Browse View -->
    <div id="browseView" class="view">
        <section id="hero" class="relative h-[60vh] min-h-[400px] w-full flex items-center text-white bg-cover bg-center bg-no-repeat" style="background-image: url('https://placehold.co/1920x1080/1a202c/718096?text=TVPinas');">
            <div class="hero-gradient absolute inset-0"></div>
            <div class="relative z-10 p-8 md:p-16 max-w-2xl">
                <h1 id="heroChannelName" class="text-4xl md:text-6xl font-extrabold drop-shadow-lg flex items-center gap-3 hero-featured">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/9/99/Flag_of_the_Philippines.svg" class="inline w-12 h-12" alt="TVPinas logo">
                    <span>Channel Name</span>
                </h1>
                <p class="mt-4 text-lg max-w-prose text-gray-200 drop-shadow-md flex items-center gap-2">
                    <i class="fas fa-circle-play text-blue-400 text-2xl"></i>
                    Welcome to your modern IPTV experience. Select a channel from the rows below, search for your favorite, or press play to start the featured channel.
                </p>
                <div class="mt-8 flex space-x-4">
                    <button id="heroPlayButton" class="flex items-center justify-center bg-blue-500 text-white font-bold py-3 px-8 rounded-md hover:bg-blue-700 shadow-lg transition-all duration-200 animate-pulse">
                        <i class="fas fa-play mr-2"></i> Play
                    </button>
                </div>
            </div>
        </section>
        <main id="rowsContainer" class="p-8 md:p-12 -mt-16 relative z-10">
            <input type="text" id="searchInput" class="search-bar" placeholder="Search for a channel...">
            <!-- Rows will be dynamically inserted here -->
        </main>
    </div>

    <!-- Player View -->
    <div id="playerView" class="view hidden fixed inset-0 bg-black flex items-center justify-center z-50">
        <video id="videoPlayer" class="w-full h-full" controls autoplay></video>
        <div id="loading" class="loader absolute hidden"></div>
        <button id="backToBrowse" class="absolute top-5 left-5 z-50 bg-black bg-opacity-50 rounded-full w-12 h-12 flex items-center justify-center text-2xl hover:bg-opacity-75 transition-all">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <footer class="w-full mt-16">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4 px-4">
            <div class="flex items-center gap-2 text-lg">
                <img src="https://upload.wikimedia.org/wikipedia/commons/9/99/Flag_of_the_Philippines.svg" class="w-8 h-8 animate-pulse" alt="TVPinas logo">
                <span><b>TVPinas</b> &copy; 2025</span>
            </div>
            <div class="footer-icons mb-2 md:mb-0">
                <a href="https://t.me/harleyiptv" target="_blank" title="Telegram" aria-label="Telegram">
                    <i class="fab fa-telegram-plane"></i>
                </a>
            </div>
            <div>
                <button id="aboutBtn" class="text-2xl text-blue-400 hover:text-white focus:outline-none" title="About">
                    <i class="fas fa-circle-info"></i>
                </button>
            </div>
        </div>
        <div class="text-center footer-visit">
            <span class="visit-count" id="visitCount"><i class="fas fa-users"></i> Visits: <span id="visitNum">...</span></span>
        </div>
    </footer>

    <!-- About Overlay -->
    <div id="aboutOverlay" class="about-overlay">
        <div class="about-modal">
            <button class="about-close" id="closeAbout" title="Close">&times;</button>
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/99/Flag_of_the_Philippines.svg" class="about-logo" alt="TVPinas logo">
            <h2 class="text-2xl font-bold mb-2 flex items-center justify-center gap-2">
                <i class="fas fa-tv text-blue-400"></i> About TVPinas
            </h2>
            <p class="mb-4 text-gray-300 text-base">
                TVPinas is a modern IPTV player for Filipinos worldwide, delivering a smooth, beautiful, and fast TV experience.<br><br>
                <b>Features:</b>
                <ul class="text-left mt-2 mb-4 list-none text-base flex flex-col gap-1">
                    <li><i class="fas fa-bolt text-yellow-400 mr-2"></i> Lightning-fast channel search</li>
                    <li><i class="fas fa-layer-group text-green-400 mr-2"></i> Grouped & categorized channels</li>
                    <li><i class="fas fa-broadcast-tower text-blue-400 mr-2"></i> Adaptive streaming (DASH/HLS)</li>
                    <li><i class="fas fa-mobile-alt text-pink-400 mr-2"></i> Mobile and desktop friendly</li>
                    <li><i class="fas fa-cloud text-cyan-300 mr-2"></i> Powered by Firebase</li>
                </ul>
                <b>Contact:</b>
                <br>
                <a href="https://t.me/harleyiptv" class="footer-link" target="_blank"><i class="fab fa-telegram-plane"></i> Telegram</a>
            </p>
            <div class="visit-count mt-3" style="justify-content:center;">
                <i class="fas fa-users"></i> Site visits: <span id="aboutVisitNum">...</span>
            </div>
            <div class="text-xs text-gray-400 mt-5">
                Not affiliated with any TV network. For personal and educational viewing only.<br>
                &copy; 2025 TVPinas
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAOD_WjTx_QV4NmdWOA1qn1iw2Bfhck8do",
            authDomain: "harley1-dc7c4.firebaseapp.com",
            projectId: "harley1-dc7c4",
            storageBucket: "harley1-dc7c4.appspot.com",
            messagingSenderId: "364436057378",
            appId: "1:364436057378:web:4e6a59f39f132e0dc1897b",
            measurementId: "G-XJDDS9HC2S",
            databaseURL: "https://harley1-dc7c4-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // --- DOM Elements ---
        const browseView = document.getElementById('browseView');
        const playerView = document.getElementById('playerView');
        const video = document.getElementById('videoPlayer');
        const loading = document.getElementById('loading');
        const backToBrowseBtn = document.getElementById('backToBrowse');
        const rowsContainer = document.getElementById('rowsContainer');
        const heroSection = document.getElementById('hero');
        const heroChannelName = document.getElementById('heroChannelName');
        const heroPlayButton = document.getElementById('heroPlayButton');
        const searchInput = document.getElementById('searchInput');
        const aboutBtn = document.getElementById('aboutBtn');
        const aboutOverlay = document.getElementById('aboutOverlay');
        const closeAbout = document.getElementById('closeAbout');
        const visitNum = document.getElementById('visitNum');
        const aboutVisitNum = document.getElementById('aboutVisitNum');

        let shakaPlayer = null;
        let featuredChannel = null;
        let allChannels = [];
        let filteredChannels = [];

        // --- Categories for grouping ---
        const categories = {
            "All Channels": [],
            "Philippines":   ['abs', 'gma', 'tfc', 'kapamilya', 'cinema one', 'jeepney', 'knowledge channel', 'knowledge ch', 'cignal', 'tv5', 'one sports', 'ptv', 'untv', 'net25', 'a2z', 'light tv', 'inc tv', 'cig', 'pba', 'cnn philippines', 'solar sports', 'cnn ph', 'dzbb', 'dzrh', 'gcnn', 'smni', 'ibc', 'cignal', 'one ph', 'cignal', 'pinoy', 'cignaltv', 'gma news', 'gma regional', 'gma life', 'gma heart', 'gma pinoy', 'gma sports', 'gma music', 'gma kids', 'gma drama', 'gma comedy', 'gma movies', 'gma anime', 'gma docu', 'gma public affairs', 'gma lifestyle', 'gma regional tv', 'cignal play', 'cignal live', 'cignal now', 'cignal streaming', 'cignal hd', 'cignal sd', 'cignal cable', 'cignal satellite', 'cignal prepaid', 'cignal postpaid', 'cignal account', 'cignal app', 'cignal box', 'cignal channels', 'cignal guide', 'cignal help', 'cignal info', 'cignal load', 'cignal online', 'cignal package', 'cignal plan', 'cignal prepaid', 'cignal promo', 'cignal satellite', 'cignal sd', 'cignal tv', 'tfc'],
            "GMA":          ['gma', 'gma news', 'gma pinoy', 'gma heart', 'gma life', 'gma sports', 'gma music', 'gma kids', 'gma drama', 'gma comedy', 'gma movies', 'gma anime', 'gma docu', 'gma public affairs', 'gma lifestyle', 'gma regional', 'gma regional tv'],
            "TFC":          ['tfc', 'kapamilya', 'cinema one', 'jeepney', 'knowledge channel', 'knowledge ch', 'a2z'],
            "CIG":          ['cig', 'cignal', 'cignal play', 'cignal live', 'cignal now', 'cignal streaming', 'cignal hd', 'cignal sd', 'cignal cable', 'cignal satellite', 'cignal prepaid', 'cignal postpaid', 'cignal account', 'cignal app', 'cignal box', 'cignal channels', 'cignal guide', 'cignal help', 'cignal info', 'cignal load', 'cignal online', 'cignal package', 'cignal plan', 'cignal prepaid', 'cignal promo', 'cignal satellite', 'cignal sd', 'cignal tv'],
            "Movies":       ['movie', 'hbo', 'cinemax', 'hits', 'thrill', 'celestial', 'tvn', 'sky movies', 'fox movies', 'mgm', 'tcm', 'axn', 'star movies', 'star gold', 'movies now', 'sony pix', 'mnx', 'wb movies', 'zee studio'],
            "Entertainment":['axn', 'warner', 'one', 'paramount', 'rock', 'animax', 'dreamworks', 'scm', 'kplus'],
            "Documentaries":['natgeo', 'discovery', 'history', 'animal planet', 'bbc earth', 'crime'],
            "Lifestyle":    ['lifestyle', 'tlc', 'food', 'hgtv', 'fashion']
        };
        const categoryIcons = {
            "All Channels": '<i class="fas fa-th-large category-icon text-white"></i>',
            "Philippines":   '<i class="fas fa-flag category-icon text-blue-400"></i>',
            "GMA":           '<img src="https://upload.wikimedia.org/wikipedia/commons/7/7b/GMA_Network_logo_2017.png" class="category-icon" style="height:1.5em;display:inline" alt="GMA">',
            "TFC":           '<img src="https://static.wikia.nocookie.net/logopedia/images/4/48/TFC_2013.png" class="category-icon" style="height:1.5em;display:inline" alt="TFC">',
            "CIG":           '<img src="https://upload.wikimedia.org/wikipedia/commons/b/b7/Cignal_TV_logo_%28new%29.png" class="category-icon" style="height:1.5em;display:inline" alt="CIG">',
            "Movies":        '<i class="fas fa-film category-icon text-red-400"></i>',
            "Entertainment": '<i class="fas fa-tv category-icon text-pink-400"></i>',
            "Documentaries": '<i class="fas fa-book category-icon text-green-400"></i>',
            "Lifestyle":     '<i class="fas fa-utensils category-icon text-yellow-400"></i>'
        };

        function categorizeChannels(channelList) {
            const categorized = {};
            for (const category in categories) categorized[category] = [];
            categorized["All Channels"] = [...channelList];
            channelList.forEach(channel => {
                const lowerCaseName = channel.name.toLowerCase();
                for (const category in categories) {
                    if (category === "All Channels") continue;
                    if (categories[category].some(keyword => lowerCaseName.includes(keyword))) {
                        categorized[category].push(channel);
                        break;
                    }
                }
            });
            return categorized;
        }

        function createChannelTile(channel) {
            const tile = document.createElement('div');
            tile.className = 'channel-tile w-60 h-36 bg-gray-800 rounded-md flex flex-col items-center justify-center p-3 cursor-pointer text-center relative overflow-hidden shadow hover:shadow-lg';
            tile.tabIndex = 0;
            let content = '';
            if (channel.logoUrl) {
                content += `<img src="${channel.logoUrl}" alt="${channel.name} Logo" class="channel-logo relative z-10" loading="lazy">`;
            }
            content += `<span class="relative z-10 font-bold text-lg">${channel.name}</span>`;
            content += `<div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>`;
            tile.innerHTML = content;
            if (channel.logoUrl) {
                const img = tile.querySelector('img');
                img.onerror = function() {
                    img.src = "https://upload.wikimedia.org/wikipedia/commons/9/99/Flag_of_the_Philippines.svg";
                };
            }
            tile.addEventListener('click', () => {
                loadChannel(channel.url, channel.name);
                showPlayerView();
            });
            return tile;
        }

        function createRow(category, channels) {
            if (category === "All Channels" && channels.length < 2) return null;
            const rowWrapper = document.createElement('div');
            rowWrapper.className = 'mb-8 row group';
            const title = document.createElement('h2');
            title.className = 'text-2xl font-bold mb-4 flex items-center gap-2';
            title.innerHTML = (categoryIcons[category] || '') + category;
            const rowContainer = document.createElement('div');
            rowContainer.className = 'relative';
            const rowContent = document.createElement('div');
            rowContent.className = 'row-container flex items-center space-x-4 overflow-x-auto pb-4';
            channels.forEach(channel => rowContent.appendChild(createChannelTile(channel)));
            const leftArrow = document.createElement('button');
            leftArrow.className = 'row-arrow absolute left-0 top-0 bottom-0 px-4 z-20 hover:bg-black/75';
            leftArrow.innerHTML = '<i class="fas fa-chevron-left"></i>';
            leftArrow.addEventListener('click', () => {
                rowContent.scrollBy({ left: -rowContent.clientWidth * 0.8, behavior: 'smooth' });
            });
            const rightArrow = document.createElement('button');
            rightArrow.className = 'row-arrow absolute right-0 top-0 bottom-0 px-4 z-20 hover:bg-black/75';
            rightArrow.innerHTML = '<i class="fas fa-chevron-right"></i>';
            rightArrow.addEventListener('click', () => {
                rowContent.scrollBy({ left: rowContent.clientWidth * 0.8, behavior: 'smooth' });
            });
            rowContainer.append(leftArrow, rightArrow, rowContent);
            rowWrapper.append(title, rowContainer);
            return rowWrapper;
        }

        function renderUI() {
            const categorized = categorizeChannels(filteredChannels);
            const children = Array.from(rowsContainer.children);
            children.forEach(child => {
                if (child !== searchInput) rowsContainer.removeChild(child);
            });
            let anyResults = false;
            for (const category of Object.keys(categorized)) {
                if (categorized[category].length > 0) {
                    const row = createRow(category, categorized[category]);
                    if (row) {
                        rowsContainer.appendChild(row);
                        anyResults = true;
                    }
                }
            }
            if (!anyResults) {
                const noResult = document.createElement('div');
                noResult.textContent = "No channels found.";
                noResult.className = "text-center text-xl font-semibold text-gray-400 mt-8";
                rowsContainer.appendChild(noResult);
            }
            let heroCats = categorized["Philippines"];
            if (!heroCats.length) heroCats = categorized["Movies"];
            if (!heroCats.length) heroCats = categorized["All Channels"];
            if (heroCats.length > 0) {
                featuredChannel = heroCats[Math.floor(Math.random() * heroCats.length)];
                heroChannelName.innerHTML = `<img src="https://upload.wikimedia.org/wikipedia/commons/9/99/Flag_of_the_Philippines.svg" class="inline w-12 h-12" alt="TVPinas logo"> <span>${featuredChannel.name}</span>`;
                const placeholderImageUrl = `https://placehold.co/1920x1080/1f2937/a0aec0?text=${encodeURIComponent(featuredChannel.name)}`;
                heroSection.style.backgroundImage = `url('${placeholderImageUrl}')`;
            }
        }

        function showPlayerView() {
            browseView.classList.add('hidden');
            playerView.classList.remove('hidden');
        }
        function showBrowseView() {
            playerView.classList.add('hidden');
            browseView.classList.remove('hidden');
            if (shakaPlayer) shakaPlayer.destroy();
            video.pause();
            video.src = "";
        }
        function isManifestUrl(url) {
            return url.endsWith('.mpd') || url.endsWith('.m3u8');
        }
        async function loadChannel(url, name) {
            loading.classList.remove('hidden');
            if (shakaPlayer) shakaPlayer.destroy();
            video.pause();
            video.src = "";
            shaka.polyfill.installAll();
            if (!shaka.Player.isBrowserSupported()) {
                loading.classList.add('hidden');
                alert("Your browser does not support Shaka Player streaming.");
                showBrowseView();
                return;
            }
            shakaPlayer = new shaka.Player(video);
            shakaPlayer.addEventListener('error', (event) => {
                loading.classList.add('hidden');
                alert(`Error loading channel: ${name}. Stream may be offline or not supported.`);
                showBrowseView();
            });
            try {
                await shakaPlayer.load(url);
                video.play().catch(e => {});
                loading.classList.add('hidden');
            } catch (e) {
                loading.classList.add('hidden');
                alert(`Error loading channel: ${name}. Stream may be offline or not supported.`);
                showBrowseView();
            }
        }
        backToBrowseBtn.addEventListener('click', showBrowseView);
        heroPlayButton.addEventListener('click', () => {
            if (featuredChannel) {
                loadChannel(featuredChannel.url, featuredChannel.name);
                showPlayerView();
            }
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !playerView.classList.contains('hidden')) {
                showBrowseView();
            }
            if(e.key === 'Escape' && aboutOverlay.classList.contains('active')) {
                aboutOverlay.classList.remove('active');
            }
        });

        function filterChannelsBySearch(value) {
            if (!value) return allChannels;
            value = value.trim().toLowerCase();
            return allChannels.filter(channel => channel.name.toLowerCase().includes(value));
        }
        searchInput.addEventListener('input', () => {
            filteredChannels = filterChannelsBySearch(searchInput.value);
            renderUI();
        });

        aboutBtn.addEventListener('click', () => {
            aboutOverlay.classList.add('active');
        });
        closeAbout.addEventListener('click', () => {
            aboutOverlay.classList.remove('active');
        });
        aboutOverlay.addEventListener('click', (e) => {
            if (e.target === aboutOverlay) aboutOverlay.classList.remove('active');
        });

        async function loadChannelsFromFirebase() {
            allChannels = [];
            try {
                const snapshot = await db.collection("freeserver").get();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.name && data.url && isManifestUrl(data.url)) {
                        allChannels.push({
                            name: data.name,
                            url: data.url,
                            logoUrl: data.image || ""
                        });
                    }
                });
            } catch (err) {
                alert("Failed to load channels from server.");
            }
            filteredChannels = allChannels;
            renderUI();
        }
        loadChannelsFromFirebase();

        // --- Visit Counter (Realtime DB) ---
        function setVisitCount(n) {
            visitNum.textContent = n;
            aboutVisitNum.textContent = n;
        }
        function updateVisitCount() {
            const counterRef = rtdb.ref('siteVisits');
            counterRef.transaction(current => (current || 0) + 1).then();
            counterRef.on('value', snap => {
                setVisitCount(snap.val() || 1);
            });
        }
        updateVisitCount();
    });
    </script>
</body>
</html>